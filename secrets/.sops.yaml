# sops-nix configuration
# See: https://github.com/Mic92/sops-nix
#
# This file configures which keys can encrypt/decrypt which secrets.
# Uses Yubikey-backed age keys via age-plugin-yubikey.
#
# To set up a new Yubikey:
# 1. Run the setup wizard:
#    age-plugin-yubikey
#
# 2. Save the identity file:
#    age-plugin-yubikey --identity > ~/.config/sops/age/yubikey-identity.txt
#    chmod 600 ~/.config/sops/age/yubikey-identity.txt
#
# 3. Get your public key:
#    age-plugin-yubikey --list
#
# 4. Add the public key below under 'keys'
#
# 5. Create/edit secrets (requires Yubikey touch):
#    cd ~/Projects/dotfiles/secrets
#    SOPS_AGE_KEY_FILE=~/.config/sops/age/yubikey-identity.txt sops secrets.yaml

keys:
  # John's Yubikey 5C NFC (primary)
  # Yubikey-backed age key - private key never leaves hardware
  - &john age1yubikey1qghhvxsh9ttxpqvnf3um7fuv7y0ut4hvl5gk2rgwtezj0e2avkmd7chvckq

  # Future: Backup Yubikey
  # - &john-backup age1yubikey1q...

  # Host-specific keys (derived from SSH host keys via ssh-to-age)
  # These allow decryption without Yubikey present
  # Generate with: sudo cat /etc/ssh/ssh_host_ed25519_key | ssh-to-age
  # - &mac-studio age1...
  # - &inOneEar age1...
  - &sleeper-service PLACEHOLDER_RUN_ssh-to-age_ON_sleeper-service

# Creation rules define which keys can access which files
creation_rules:
  # Default rule: all secrets encrypted to john's Yubikey
  # Add host keys here after generating them to allow those hosts to decrypt
  - path_regex: secrets\.yaml$
    key_groups:
      - age:
          - *john
          # Uncomment after adding sleeper-service's age key:
          # - *sleeper-service
